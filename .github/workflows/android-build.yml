name: Android CI Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: è®¾ç½®JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: æˆäºˆGradlewæ‰§è¡Œæƒé™
      run: chmod +x AndroidCaptchaSolver/gradlew
      
    - name: ä½¿ç”¨Gradleç¼–è¯‘Debug APK
      run: |
        cd AndroidCaptchaSolver
        ./gradlew assembleDebug --stacktrace
        
    - name: æŸ¥æ‰¾APKæ–‡ä»¶
      run: |
        echo "å¯»æ‰¾ç¼–è¯‘å¥½çš„APKæ–‡ä»¶..."
        find AndroidCaptchaSolver/app/build/outputs -name "*.apk" -type f
        
    - name: ä¸Šä¼ APKæ–‡ä»¶
      uses: actions/upload-artifact@v3
      with:
        name: app-debug
        path: AndroidCaptchaSolver/app/build/outputs/apk/debug/*.apk
        retention-days: 30
        
    - name: è·å–çŸ­æäº¤SHA
      id: slug
      run: echo "sha8=$(echo ${{github.sha}} | cut -c1-8)" >> $GITHUB_OUTPUT
      
    - name: é‡å‘½åAPKï¼ˆå¯é€‰ï¼‰
      run: |
        cd AndroidCaptchaSolver/app/build/outputs/apk/debug
        for file in *.apk; do
          mv "$file" "captcha-solver-${{ steps.slug.outputs.sha8 }}.apk"
        done
        
    - name: åˆ›å»ºReleaseï¼ˆæ¨é€åˆ°mainæ—¶ï¼‰
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: Release v1.0.${{ github.run_number }}
        body: |
          ğŸ‰ è‡ªåŠ¨ç¼–è¯‘ç‰ˆæœ¬
          
          **ä¿®æ”¹å†…å®¹ï¼š**
          - ä¿®å¤Chromeæµè§ˆå™¨äº‹ä»¶é¢‘ç¹è§¦å‘å¯¼è‡´æ— æ³•è¯†åˆ«çš„é—®é¢˜
          - æ·»åŠ å¤„ç†é—´éš”æ§åˆ¶ï¼Œé˜²æ­¢é‡å¤è§¦å‘
          - åªç›‘å¬çª—å£çŠ¶æ€æ”¹å˜äº‹ä»¶
          
          **æäº¤ä¿¡æ¯ï¼š**
          - Commit: ${{ github.sha }}
          - ä½œè€…: ${{ github.actor }}
          
          è¯·ä¸‹è½½ä¸‹æ–¹çš„APKæ–‡ä»¶å®‰è£…åˆ°æ‰‹æœº
        files: AndroidCaptchaSolver/app/build/outputs/apk/debug/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
