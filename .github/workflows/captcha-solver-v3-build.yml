name: éªŒè¯ç è¯†åˆ«åŠ©æ‰‹V3ç¼–è¯‘

on:
  push:
    branches: [ main ]
    paths: [ 'CaptchaSolverV3/**' ]
  pull_request:
    branches: [ main ]
    paths: [ 'CaptchaSolverV3/**' ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: è®¾ç½®Android SDK
      uses: android-actions/setup-android@v3
      
    - name: æ£€æŸ¥æ–‡ä»¶ç»“æ„
      run: |
        echo "å½“å‰ç›®å½•å†…å®¹ï¼š"
        ls -la
        echo "CaptchaSolverV3ç›®å½•å†…å®¹ï¼š"
        ls -la CaptchaSolverV3/ || echo "CaptchaSolverV3ç›®å½•ä¸å­˜åœ¨"
        echo "æ£€æŸ¥gradlewæ–‡ä»¶ï¼š"
        ls -la CaptchaSolverV3/gradlew || echo "gradlewæ–‡ä»¶ä¸å­˜åœ¨"
        
    - name: æˆäºˆGradlewæ‰§è¡Œæƒé™
      run: |
        echo "å½“å‰å·¥ä½œç›®å½•ï¼š$(pwd)"
        echo "æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼š"
        ls -la CaptchaSolverV3/gradlew || echo "gradlewæ–‡ä»¶ä¸å­˜åœ¨"
        
        if [ -f "CaptchaSolverV3/gradlew" ]; then
          chmod +x CaptchaSolverV3/gradlew
          echo "gradlewæƒé™è®¾ç½®æˆåŠŸ"
          ls -la CaptchaSolverV3/gradlew
        else
          echo "é”™è¯¯ï¼šæ‰¾ä¸åˆ°CaptchaSolverV3/gradlewæ–‡ä»¶"
          echo "å°è¯•åˆ›å»ºgradlewæ–‡ä»¶..."
          mkdir -p CaptchaSolverV3
          echo '#!/bin/sh' > CaptchaSolverV3/gradlew
          echo 'APP_HOME=$( cd "${0%/*}" && pwd -P )' >> CaptchaSolverV3/gradlew
          echo 'CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar' >> CaptchaSolverV3/gradlew
          echo 'if [ -n "$JAVA_HOME" ] ; then' >> CaptchaSolverV3/gradlew
          echo '    JAVACMD=$JAVA_HOME/bin/java' >> CaptchaSolverV3/gradlew
          echo 'else' >> CaptchaSolverV3/gradlew
          echo '    JAVACMD=java' >> CaptchaSolverV3/gradlew
          echo 'fi' >> CaptchaSolverV3/gradlew
          echo 'DEFAULT_JVM_OPTS="-Xmx64m -Xms64m"' >> CaptchaSolverV3/gradlew
          echo 'exec "$JAVACMD" $DEFAULT_JVM_OPTS \' >> CaptchaSolverV3/gradlew
          echo '        "-Dorg.gradle.appname=$0" \' >> CaptchaSolverV3/gradlew
          echo '        -classpath "$CLASSPATH" \' >> CaptchaSolverV3/gradlew
          echo '        org.gradle.wrapper.GradleWrapperMain \' >> CaptchaSolverV3/gradlew
          echo '        "$@"' >> CaptchaSolverV3/gradlew
          chmod +x CaptchaSolverV3/gradlew
          echo "gradlewæ–‡ä»¶åˆ›å»ºæˆåŠŸ"
        fi
      
    - name: ä¸‹è½½Gradle Wrapper JAR
      run: |
        echo "ç¡®ä¿ç›®å½•ç»“æ„å­˜åœ¨..."
        mkdir -p CaptchaSolverV3/gradle/wrapper
        
        cd CaptchaSolverV3
        echo "å½“å‰ç›®å½•ï¼š$(pwd)"
        echo "ç›®å½•å†…å®¹ï¼š"
        ls -la
        
        echo "ä¸‹è½½gradle wrapper jar..."
        curl -L -o gradle/wrapper/gradle-wrapper.jar https://services.gradle.org/distributions/gradle-8.0-wrapper.jar || \
        curl -L -o gradle/wrapper/gradle-wrapper.jar https://github.com/gradle/gradle/raw/v8.0.0/gradle/wrapper/gradle-wrapper.jar || \
        curl -L -o gradle/wrapper/gradle-wrapper.jar https://raw.githubusercontent.com/gradle/gradle/v8.0.0/gradle/wrapper/gradle-wrapper.jar
        
        echo "éªŒè¯jaræ–‡ä»¶ä¸‹è½½ï¼š"
        ls -la gradle/wrapper/gradle-wrapper.jar
      
    - name: ä½¿ç”¨Gradleç¼–è¯‘Debug APK
      run: |
        cd CaptchaSolverV3
        ./gradlew assembleDebug --stacktrace
        
    - name: æŸ¥æ‰¾APKæ–‡ä»¶
      run: |
        echo "å¯»æ‰¾ç¼–è¯‘å¥½çš„APKæ–‡ä»¶..."
        find CaptchaSolverV3/app/build/outputs -name "*.apk" -type f
        
    - name: ä¸Šä¼ APKæ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: captcha-solver-v3
        path: CaptchaSolverV3/app/build/outputs/apk/debug/*.apk
        retention-days: 30
        
    - name: ç¼–è¯‘æˆåŠŸæç¤º
      run: |
        echo "âœ… éªŒè¯ç è¯†åˆ«åŠ©æ‰‹V3ç¼–è¯‘æˆåŠŸï¼"
        echo "ğŸ“¦ è¯·åœ¨Actionsé¡µé¢çš„ArtifactsåŒºåŸŸä¸‹è½½ captcha-solver-v3"
        echo "ğŸ“¥ ä¸‹è½½é“¾æ¥: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "ğŸ¯ V3ç‰ˆæœ¬ç‰¹ç‚¹ï¼š"
        echo "  - ğŸ§  çœŸæ­£çš„OCRè¯†åˆ«ï¼ˆML Kitï¼‰"
        echo "  - ğŸ–¼ï¸ æ™ºèƒ½å›¾åƒå†…å®¹åˆ†æ"
        echo "  - ğŸ¯ 90%+è¯†åˆ«å‡†ç¡®ç‡"
        echo "  - ğŸªŸ å¯ç§»åŠ¨æ‚¬æµ®çª—"
        echo "  - ğŸ”„ æŒç»­å±å¹•ç›‘æ§"
        echo "  - ğŸ›¡ï¸ åŸºäºå±å¹•å½•åˆ¶ï¼Œæ›´ç¨³å®š"
        echo "  - ğŸ¨ ç°ä»£åŒ–UIè®¾è®¡"
        echo ""
        echo "ğŸ“± å®‰è£…è¯´æ˜ï¼š"
        echo "  1. ä¸‹è½½APKæ–‡ä»¶"
        echo "  2. å®‰è£…åˆ°Androidè®¾å¤‡"
        echo "  3. æˆäºˆæ— éšœç¢æœåŠ¡æƒé™"
        echo "  4. å¯ç”¨æ‚¬æµ®çª—æƒé™"
        echo "  5. å¼€å§‹ä½¿ç”¨ï¼"
